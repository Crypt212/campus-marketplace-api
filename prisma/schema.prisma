generator client {
    provider = "prisma-client-js"
    output   = "../src/libs/prisma"
}

datasource db {
    provider = "postgresql"
}

enum Role {
    STUDENT
    ADMIN
    SUPER_ADMIN
}

enum VerificationStatus {
    PENDING
    VERIFIED
    REJECTED
}

enum ListingType {
    SELL
    RENT
    BOTH
}

enum OrderType {
    SELL
    RENT
}

enum OrderStatus {
    PENDING
    NEGOTIATING
    APPROVED
    REJECTED
    PAYMENT_PENDING
    PAID
    ACTIVE
    COMPLETED
    CANCELLED
}

enum PaymentStatus {
    INITIATED
    SUCCESS
    FAILED
    REFUNDED
}

enum ReportStatus {
    OPEN
    RESOLVED
    REJECTED
}

// ---------------------- Identity ----------------------
model User {
    id              String   @id @default(uuid())
    email           String   @unique
    password        String
    role            Role     @default(STUDENT)
    isEmailVerified Boolean  @default(false)
    
    // Email verification
    emailVerificationToken String?
    emailVerificationExpires DateTime?
    
    // Password reset
    passwordResetToken String?
    passwordResetExpires DateTime?
    
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    student    Student?
    admin      Admin?
    superAdmin SuperAdmin?

    chatsSent   Message[] @relation("SenderMessages")
    reportsMade Report[]  @relation("ReporterReports")
}

model Student {
    id              String   @id @default(uuid())
    userId          String   @unique
    user            User     @relation(fields: [userId], references: [id])
    studentId       String?
    universityEmail String   @unique
    grade           String?
    department      String?
    ratingAverage   Float    @default(0)
    ratingCount     Int      @default(0)
    isActive        Boolean  @default(true)
    createdAt       DateTime @default(now())

    listings        Listing[]
    ordersAsBuyer   Order[]   @relation("BuyerOrders")
    ordersAsSeller  Order[]   @relation("SellerOrders")
    reviewsGiven    Review[]  @relation("ReviewerReviews")
    reviewsReceived Review[]  @relation("ReviewedStudentReviews")
}

model Admin {
    id           String      @id @default(uuid())
    userId       String      @unique
    user         User        @relation(fields: [userId], references: [id])
    isApproved   Boolean     @default(false)
    approvedById String?
    approvedBy   SuperAdmin? @relation(fields: [approvedById], references: [id])
    approvedAt   DateTime?
    createdAt    DateTime    @default(now())
    reports      Report[]
}

model SuperAdmin {
    id     String  @id @default(uuid())
    userId String  @unique
    user   User    @relation(fields: [userId], references: [id])
    admins Admin[]
}

// ---------------------- Marketplace ----------------------
model Listing {
    id          String      @id @default(uuid())
    ownerId     String
    owner       Student     @relation(fields: [ownerId], references: [id])
    title       String
    description String
    category    String
    price       Float
    listingType ListingType
    condition   String
    isAvailable Boolean     @default(true)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    orders  Order[]
    reviews Review[]
}

model Order {
    id            String      @id @default(uuid())
    listingId     String
    listing       Listing     @relation(fields: [listingId], references: [id])
    buyerId       String
    buyer         Student     @relation("BuyerOrders", fields: [buyerId], references: [id])
    sellerId      String
    seller        Student     @relation("SellerOrders", fields: [sellerId], references: [id])
    type          OrderType
    status        OrderStatus @default(PENDING)
    totalPrice    Float
    proposedStart DateTime?
    proposedEnd   DateTime?
    approvedStart DateTime?
    approvedEnd   DateTime?
    createdAt     DateTime    @default(now())
    updatedAt     DateTime    @updatedAt

    payment       Payment?
    rentAgreement RentAgreement?
    chat          Chat?
}

model RentAgreement {
    id                 String   @id @default(uuid())
    orderId            String   @unique
    order              Order    @relation(fields: [orderId], references: [id])
    startDate          DateTime
    endDate            DateTime
    isApprovedBySeller Boolean  @default(false)
}

model Payment {
    id                  String        @id @default(uuid())
    orderId             String        @unique
    order               Order         @relation(fields: [orderId], references: [id])
    paymobTransactionId String?
    amount              Float
    status              PaymentStatus @default(INITIATED)
    paidAt              DateTime?
    createdAt           DateTime      @default(now())
    updatedAt           DateTime      @updatedAt
}

// ---------------------- Communication ----------------------
model Chat {
    id        String    @id @default(uuid())
    orderId   String    @unique
    order     Order     @relation(fields: [orderId], references: [id])
    messages  Message[]
    createdAt DateTime  @default(now())
}

model Message {
    id       String   @id @default(uuid())
    chatId   String
    chat     Chat     @relation(fields: [chatId], references: [id])
    senderId String
    sender   User     @relation("SenderMessages", fields: [senderId], references: [id])
    content  String
    sentAt   DateTime @default(now())
}

// ---------------------- Reviews & Ratings ----------------------
model Review {
    id                String   @id @default(uuid())
    listingId         String
    listing           Listing  @relation(fields: [listingId], references: [id])
    reviewerId        String
    reviewer          Student  @relation("ReviewerReviews", fields: [reviewerId], references: [id])
    reviewedStudentId String
    reviewedStudent   Student  @relation("ReviewedStudentReviews", fields: [reviewedStudentId], references: [id])
    rating            Int
    comment           String?
    createdAt         DateTime @default(now())
}

// ---------------------- Moderation ----------------------
model Report {
    id                String       @id @default(uuid())
    reporterId        String
    reporter          User         @relation("ReporterReports", fields: [reporterId], references: [id])
    reportedUserId    String?
    reportedListingId String?
    reason            String
    status            ReportStatus @default(OPEN)
    handledById       String?
    handledBy         Admin?       @relation(fields: [handledById], references: [id])
    createdAt         DateTime     @default(now())
}
